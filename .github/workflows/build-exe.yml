name: Build Mega EXE

on:
  push:
    branches: [ main, 'cursor/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² Ð¿Ð¾Ð»Ð½Ð¾Ñ‡ÑŒ UTC Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
    - cron: '0 0 * * *'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Build Mega EXE
      shell: pwsh
      env:
        RUSTFLAGS: -C target-feature=+crt-static
        CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUSTFLAGS: -C target-feature=+crt-static
      run: |
        Write-Host "Building with features: gui,all-integrations"
        cargo build --release --target x86_64-pc-windows-msvc --features "gui,all-integrations" --bin adaptive-entity-engine 2>&1 | Tee-Object -Variable buildOutput
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Build failed!"
          Write-Host $buildOutput
          exit 1
        }
    
    - name: Create dist directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path dist\windows | Out-Null
    
    - name: Copy EXE
      shell: pwsh
      run: |
        if (Test-Path "target\x86_64-pc-windows-msvc\release\adaptive-entity-engine.exe") {
          Copy-Item target\x86_64-pc-windows-msvc\release\adaptive-entity-engine.exe dist\windows\ -Force
          Write-Host "EXE copied successfully"
          Get-Item dist\windows\adaptive-entity-engine.exe | Select-Object Name, Length
        } else {
          Write-Error "EXE file not found!"
          exit 1
        }
    
    - name: Verify EXE exists
      shell: pwsh
      run: |
        if (-not (Test-Path "dist\windows\adaptive-entity-engine.exe")) {
          Write-Error "EXE file was not copied!"
          exit 1
        }
        $file = Get-Item "dist\windows\adaptive-entity-engine.exe"
        Write-Host "EXE file size: $($file.Length) bytes"
        if ($file.Length -lt 1000000) {
          Write-Warning "EXE file seems too small, might be corrupted"
        }
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: adaptive-entity-engine-exe
        path: dist/windows/adaptive-entity-engine.exe
        retention-days: 30
        if-no-files-found: error
    
    - name: Commit and push EXE
      shell: pwsh
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add dist/windows/adaptive-entity-engine.exe
        
        if (git diff --staged --quiet) {
          Write-Host "No changes to commit"
        } else {
          git commit -m "ðŸ¤– Auto-build: Add Mega EXE file [skip ci]"
          git push
        }
